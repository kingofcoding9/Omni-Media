<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Omni-OS v6.3 (Socket Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase (Auth Only) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root { --neon-blue: #3b82f6; --bg-dark: #050505; --glass: rgba(15, 23, 42, 0.95); }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-dark); color: #e0e0e0; font-family: 'Exo 2', sans-serif; position: fixed; inset: 0; }
        #root { height: 100%; width: 100%; display: flex; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(10px); border-right: 1px solid rgba(255, 255, 255, 0.05); }
        .anim-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6uWFyvcdPSSaM_TWz_aIytDXiw4JkO68",
            authDomain: "omni-science-hub.firebaseapp.com",
            projectId: "omni-science-hub",
            storageBucket: "omni-science-hub.firebasestorage.app",
            messagingSenderId: "540333608940",
            appId: "1:540333608940:web:d42c58081d74bf7af17ac9"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const { useState, useEffect, useRef } = React;

        // --- ROBUST SOCKET CONNECTION ---
        // 1. Determine URL: Use the current window origin (standard for HF Spaces)
        const SERVER_URL = window.location.origin; 
        
        // 2. Initialize with Polling fallback (Fixes HF firewall issues)
        console.log("Attempting Socket Connection to:", SERVER_URL);
        const socket = io(SERVER_URL, {
            transports: ['polling', 'websocket'], // Polling first is safer
            path: '/socket.io/',
            reconnectionAttempts: 10,
            timeout: 10000,
            autoConnect: true
        });

        // Debugging Events
        socket.on("connect_error", (err) => {
            console.error("Socket Connection Failed:", err.message);
        });

        // --- UTILS ---
        const compressImage = (file, maxWidth = 400) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        };

        // --- COMPONENTS ---

        function UserProfileModal({ targetUser, currentUser, onClose }) {
            const [isEditing, setIsEditing] = useState(false);
            const [bio, setBio] = useState(targetUser.bio || "No tactical data available.");
            const [displayName, setDisplayName] = useState(targetUser.displayName);
            
            const handleSave = async () => {
                if(displayName !== currentUser.displayName) {
                    await currentUser.updateProfile({ displayName });
                }
                socket.emit('update_profile', { uid: currentUser.uid, bio, displayName });
                setIsEditing(false);
            };

            const handlePhotoUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const base64 = await compressImage(file, 200);
                await currentUser.updateProfile({ photoURL: base64 });
                socket.emit('update_profile', { uid: currentUser.uid, photoURL: base64 });
            };

            const isMe = currentUser.uid === targetUser.uid;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-[#0f172a] border border-slate-700 p-6 rounded-2xl w-full max-w-sm shadow-2xl relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white"><i className="fa-solid fa-xmark text-xl"></i></button>
                        <div className="flex flex-col items-center">
                            <div className="relative group">
                                <img src={targetUser.photoURL || `https://ui-avatars.com/api/?name=${targetUser.displayName}`} className="w-24 h-24 rounded-full border-4 border-slate-800 object-cover" />
                                {isMe && (
                                    <label className="absolute inset-0 bg-black/50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 cursor-pointer transition">
                                        <i className="fa-solid fa-camera text-white"></i>
                                        <input type="file" className="hidden" onChange={handlePhotoUpload} accept="image/*" />
                                    </label>
                                )}
                            </div>
                            {isEditing ? <input value={displayName} onChange={e=>setDisplayName(e.target.value)} className="mt-4 bg-slate-800 text-white text-center font-bold rounded p-1" /> : <h2 className="text-xl font-bold text-white mt-4">{targetUser.displayName}</h2>}
                            <p className="text-xs text-blue-500 uppercase tracking-widest mt-1">Omni-Operative</p>
                            <div className="mt-6 w-full bg-slate-900/50 p-4 rounded-lg border border-slate-800">
                                <p className="text-[10px] text-slate-500 uppercase mb-2">Tactical Bio</p>
                                {isEditing ? <textarea value={bio} onChange={e=>setBio(e.target.value)} className="w-full bg-slate-800 text-white text-sm p-2 rounded h-24" /> : <p className="text-sm text-slate-300 italic">"{bio}"</p>}
                            </div>
                            {isMe && <div className="mt-6 w-full">{isEditing ? <button onClick={handleSave} className="w-full bg-green-600 hover:bg-green-500 text-white py-2 rounded font-bold uppercase text-xs">Save Profile</button> : <button onClick={() => setIsEditing(true)} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded font-bold uppercase text-xs">Edit Identity</button>}</div>}
                        </div>
                    </div>
                </div>
            );
        }

        function NavRail({ sectors, onSelect, activeId, onCreateSector }) {
            return (
                <div className="w-[72px] h-full flex flex-col items-center py-4 gap-4 glass-panel z-30 flex-shrink-0">
                    <div onClick={() => onSelect('global')} className={`flex-shrink-0 w-12 h-12 rounded-2xl flex items-center justify-center cursor-pointer transition-all ${activeId === 'global' ? 'bg-blue-600 text-white shadow-[0_0_15px_#2563eb]' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700'}`}>
                        <i className="fa-solid fa-earth-americas text-xl"></i>
                    </div>
                    <div className="w-8 h-[1px] bg-slate-700/50 flex-shrink-0"></div>
                    <div className="flex-1 w-full overflow-y-auto scroll-hide flex flex-col items-center gap-3 min-h-0">
                        {sectors.map(sector => (
                            <div key={sector.id} onClick={() => onSelect(sector.id)} className="relative group w-12 h-12 flex-shrink-0">
                                <div className={`w-full h-full rounded-2xl flex items-center justify-center cursor-pointer transition-all overflow-hidden border ${activeId === sector.id ? 'border-blue-500' : 'border-transparent group-hover:border-slate-600'}`}>
                                    {sector.icon ? <img src={sector.icon} className="w-full h-full object-cover" /> : <div className="bg-slate-800 w-full h-full flex items-center justify-center text-xs font-bold text-white">{sector.name[0]}</div>}
                                </div>
                            </div>
                        ))}
                        <div onClick={onCreateSector} className="flex-shrink-0 w-12 h-12 rounded-2xl bg-slate-800/30 border border-dashed border-slate-600 text-slate-500 hover:text-green-400 hover:border-green-400 flex items-center justify-center cursor-pointer transition"><i className="fa-solid fa-plus"></i></div>
                    </div>
                    <div onClick={() => onSelect('dms')} className={`flex-shrink-0 w-12 h-12 rounded-full mt-auto flex items-center justify-center cursor-pointer transition ${activeId === 'dms' ? 'bg-purple-600 text-white' : 'bg-slate-800 text-slate-400 hover:text-white'}`}><i className="fa-solid fa-inbox"></i></div>
                </div>
            );
        }

        function DMDirectory({ user, dms, onSelectDM }) {
            const [search, setSearch] = useState("");
            return (
                <div className="flex-1 bg-black/40 flex flex-col h-full relative z-50">
                    <header className="h-16 border-b border-slate-800 flex items-center px-4 glass-panel justify-between"><h2 className="text-lg font-bold text-white tracking-widest">DIRECT UPLINKS</h2></header>
                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                        {dms.map(dm => {
                             const otherId = dm.participants.find(p => p !== user.uid);
                             const name = dm.names ? dm.names[otherId] : "Unknown Operative";
                             return <div key={dm.id} onClick={() => onSelectDM({id: dm.id, name, type: 'dm'})} className="p-3 bg-slate-800/50 rounded-lg flex items-center gap-3 cursor-pointer hover:bg-slate-700 transition"><div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center font-bold text-white">{name[0]}</div><div><p className="font-bold text-white">{name}</p><p className="text-[10px] text-slate-400">Secure Line Active</p></div></div>
                        })}
                    </div>
                </div>
            );
        }

        function ContextSidebar({ activeSector, user, onChannelSelect, activeChannel, onCreateChannel }) {
            if (!activeSector || activeSector === 'dms') return null;
            const title = activeSector === 'global' ? "GLOBAL FEED" : activeSector.name;
            const isOwner = activeSector.ownerId === user.uid;

            return (
                <div className="w-60 h-full bg-[#0a0f16] flex flex-col border-r border-slate-800/50 z-20 flex-shrink-0 hidden md:flex"> 
                    <div className="p-4 border-b border-slate-800/50 h-16 flex flex-col justify-center flex-shrink-0">
                        <h2 className="font-bold text-white truncate text-sm tracking-wider">{title}</h2>
                        <p className="text-[10px] text-slate-500 uppercase">{activeSector === 'global' ? 'Public Relay' : 'Secure Sector'}</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-3 space-y-6 min-h-0">
                        {activeSector === 'global' ? <div className="text-center mt-10 opacity-30"><i className="fa-solid fa-globe text-4xl mb-2"></i><p className="text-xs">System Active</p></div> : 
                            ['text', 'voice', 'forum'].map(type => {
                                const channels = activeSector.channels?.filter(c => c.type === type) || [];
                                const icon = type === 'text' ? 'fa-hashtag' : (type === 'voice' ? 'fa-microphone-lines' : 'fa-layer-group');
                                return (
                                    <div key={type}>
                                        <div className="flex items-center justify-between px-2 mb-1 group"><span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">{type}</span>{isOwner && <button onClick={() => onCreateChannel(type)} className="text-slate-600 hover:text-white opacity-0 group-hover:opacity-100"><i className="fa-solid fa-plus text-[10px]"></i></button>}</div>
                                        <div className="space-y-0.5">{channels.map(ch => (<div key={ch.id} onClick={() => onChannelSelect(ch)} className={`group flex items-center justify-between px-2 py-1.5 rounded cursor-pointer transition ${activeChannel?.id === ch.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800/50'}`}><div className="flex items-center gap-2 overflow-hidden"><i className={`fa-solid ${icon} text-xs opacity-50 w-4`}></i><span className="truncate text-sm">{ch.name}</span></div></div>))}</div>
                                    </div>
                                );
                            })
                        }
                    </div>
                </div>
            );
        }

        function MainStage({ channel, user, onViewProfile }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const bottomRef = useRef();
            
            const localVideoRef = useRef();
            const remoteVideoRef = useRef();
            const peerConnection = useRef();
            const [isStreaming, setIsStreaming] = useState(false);
            const [isInCall, setIsInCall] = useState(false);

            useEffect(() => {
                if (!channel) return;
                setMessages([]);
                socket.emit('join_channel', channel.id);
                return () => socket.emit('leave_channel', channel.id);
            }, [channel]);

            useEffect(() => {
                const handleNewMsg = (msg) => {
                    setMessages(prev => [...prev, msg]);
                    setTimeout(() => bottomRef.current?.scrollIntoView({behavior:'smooth'}), 100);
                };
                const handleHistory = (hist) => {
                    setMessages(hist);
                    setTimeout(() => bottomRef.current?.scrollIntoView({behavior:'smooth'}), 100);
                };
                socket.on('new_message', handleNewMsg);
                socket.on('channel_history', handleHistory);
                return () => { socket.off('new_message', handleNewMsg); socket.off('channel_history', handleHistory); };
            }, []);

            useEffect(() => {
                if (channel?.type !== 'voice') {
                    if (peerConnection.current) peerConnection.current.close();
                    setIsStreaming(false);
                    setIsInCall(false);
                }
            }, [channel]);

            // --- VOICE LOGIC ---
            const startCall = async () => {
                setIsInCall(true);
                const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
                peerConnection.current = pc;
                pc.onicecandidate = (event) => { if (event.candidate) socket.emit('voice_signal', { target: 'broadcast', type: 'candidate', payload: event.candidate, channelId: channel.id }); };
                pc.ontrack = (event) => { if (remoteVideoRef.current) remoteVideoRef.current.srcObject = event.streams[0]; };
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => pc.addTrack(track, stream));
                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);
                    socket.emit('voice_signal', { target: 'broadcast', type: 'offer', payload: offer, channelId: channel.id });
                } catch(e) { console.error("Call Error:", e); }
            };

            const shareScreen = async () => {
                try {
                    const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                    const videoTrack = stream.getVideoTracks()[0];
                    if (peerConnection.current) {
                        const sender = peerConnection.current.getSenders().find(s => s.track.kind === 'video');
                        if (sender) sender.replaceTrack(videoTrack);
                        else peerConnection.current.addTrack(videoTrack, stream);
                    }
                    if(localVideoRef.current) localVideoRef.current.srcObject = stream;
                    setIsStreaming(true);
                    videoTrack.onended = () => { setIsStreaming(false); localVideoRef.current.srcObject = null; };
                } catch(e) { console.error("Screen Share Error", e); }
            };

            const sendMessage = (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                socket.emit('send_message', { channelId: channel.id, text, uid: user.uid, displayName: user.displayName, photoURL: user.photoURL });
                setText("");
            };

            const handleUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const base64 = await compressImage(file);
                socket.emit('send_message', { channelId: channel.id, text: "", imageURL: base64, uid: user.uid, displayName: user.displayName, photoURL: user.photoURL });
            };

            if (!channel) return <div className="flex-1 bg-black/50"></div>;

            if (channel.type === 'voice') {
                return (
                     <div className="flex-1 bg-black/20 flex flex-col relative h-full min-w-0">
                        <header className="h-16 border-b border-slate-800/50 flex-shrink-0 flex items-center px-4 glass-panel z-10"><i className="fa-solid fa-microphone-lines text-green-500 mr-3"></i><h1 className="font-bold text-white uppercase tracking-wider text-sm">{channel.name}</h1></header>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center gap-6">
                            <div className="w-full max-w-4xl aspect-video bg-black rounded-xl border border-slate-800 overflow-hidden relative group">
                                <video ref={localVideoRef} autoPlay muted className={`w-full h-full object-contain ${isStreaming ? 'block' : 'hidden'}`}></video>
                                <video ref={remoteVideoRef} autoPlay className={`w-full h-full object-contain ${!isStreaming ? 'block' : 'hidden'}`}></video>
                                {!isStreaming && !remoteVideoRef.current?.srcObject && <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-500"><i className="fa-solid fa-tower-broadcast text-4xl mb-4 opacity-50"></i><p>No active visual feed</p></div>}
                            </div>
                            <div className="flex gap-4">
                                {!isInCall ? <button onClick={startCall} className="px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-full font-bold uppercase tracking-widest transition shadow-lg shadow-green-900/50">Join Uplink</button> : <><button onClick={shareScreen} className={`px-6 py-3 rounded-full font-bold uppercase tracking-widest transition border ${isStreaming ? 'bg-red-500/20 text-red-500 border-red-500' : 'bg-slate-800 text-white hover:bg-slate-700 border-slate-600'}`}>{isStreaming ? 'Stop Sharing' : 'Share Screen'}</button><button onClick={() => setIsInCall(false)} className="px-6 py-3 bg-red-600 hover:bg-red-500 text-white rounded-full font-bold uppercase tracking-widest transition shadow-lg shadow-red-900/50"><i className="fa-solid fa-phone-slash"></i></button></>}
                            </div>
                        </div>
                     </div>
                );
            }

            return (
                <div className="flex-1 bg-black/20 flex flex-col relative h-full min-w-0">
                    <header className="h-16 border-b border-slate-800/50 flex-shrink-0 flex items-center px-4 glass-panel z-10"><i className="fa-solid fa-satellite-dish text-blue-500 mr-3"></i><h1 className="font-bold text-white uppercase tracking-wider text-sm truncate">{channel.name}</h1></header>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0">
                        {messages.map(msg => (
                            <div key={msg.id || Math.random()} className={`flex gap-3 anim-fade ${msg.uid === user.uid ? 'justify-end' : 'justify-start'}`}>
                                {msg.uid !== user.uid && <img onClick={() => onViewProfile({ uid: msg.uid, displayName: msg.displayName, photoURL: msg.photoURL })} src={msg.photoURL || `https://ui-avatars.com/api/?name=${msg.displayName}`} className="w-9 h-9 rounded-lg border border-slate-700 object-cover cursor-pointer hover:border-blue-500 transition" />}
                                <div className={`max-w-[80%] flex flex-col ${msg.uid === user.uid ? 'items-end' : 'items-start'}`}>
                                    <span className="text-xs font-bold text-slate-500 mb-1">{msg.displayName}</span>
                                    <div className={`px-4 py-2 rounded-lg text-sm break-words shadow-lg ${msg.uid === user.uid ? 'bg-blue-600/20 text-blue-50 border border-blue-500/30' : 'bg-slate-800/60 text-slate-300 border border-slate-700/50'}`}>{msg.text}{msg.imageURL && <img src={msg.imageURL} className="mt-2 rounded max-w-sm" />}</div>
                                </div>
                                {msg.uid === user.uid && <img src={msg.photoURL || `https://ui-avatars.com/api/?name=${msg.displayName}`} onClick={() => onViewProfile(user)} className="w-9 h-9 rounded-lg border border-blue-500/30 object-cover cursor-pointer" />}
                            </div>
                        ))}
                        <div ref={bottomRef}></div>
                    </div>
                    <div className="p-4 bg-black/40 border-t border-slate-800/50 flex-shrink-0">
                        <form onSubmit={sendMessage} className="relative flex gap-2">
                            <label className="p-3 bg-slate-800 rounded-lg text-slate-400 hover:text-white cursor-pointer transition">
                                <i className="fa-solid fa-paperclip"></i>
                                <input type="file" className="hidden" onChange={handleUpload} accept="image/*" />
                            </label>
                            <input value={text} onChange={e=>setText(e.target.value)} placeholder="Transmission..." className="flex-1 bg-slate-900/50 border border-slate-700 rounded-lg px-4 text-white focus:border-blue-500 outline-none transition text-sm" />
                            <button type="submit" className="p-3 text-blue-500 hover:text-white"><i className="fa-solid fa-paper-plane"></i></button>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [sectors, setSectors] = useState([]);
            const [dms, setDms] = useState([]);
            const [activeSectorId, setActiveSectorId] = useState('global');
            const [activeChannel, setActiveChannel] = useState(null);
            const [targetProfile, setTargetProfile] = useState(null);
            const [connected, setConnected] = useState(false);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async u => { 
                    if(u) {
                        setUser(u);
                        const token = await u.getIdToken();
                        socket.emit('authenticate', token);
                    }
                });
                socket.on('connect', () => setConnected(true));
                socket.on('disconnect', () => setConnected(false));
                socket.on('init_data', (data) => { setSectors(data.sectors); setDms(data.dms); });
                socket.on('update_sectors', (data) => setSectors(data));
                socket.on('update_dms', (data) => setDms(data));
                return () => unsub();
            }, []);

            useEffect(() => {
                if(activeSectorId === 'global') {
                    const sec = sectors.find(s=>s.id==='global');
                    if(sec && sec.channels) setActiveChannel(sec.channels[0]);
                } else if(activeSectorId === 'dms') {
                    setActiveChannel(null);
                } else {
                    const sec = sectors.find(s=>s.id===activeSectorId);
                    if(sec && sec.channels?.length) setActiveChannel(sec.channels[0]);
                    else setActiveChannel(null);
                }
            }, [activeSectorId, sectors]);

            const handleCreateSector = () => { const name = prompt("Sector Name:"); if(name) socket.emit('create_sector', { name, ownerId: user.uid }); };
            const handleCreateChannel = (type) => { const name = prompt("Channel Name:"); if(name) socket.emit('create_channel', { sectorId: activeSectorId, name, type }); };

            if (!user) return <div className="h-full flex items-center justify-center bg-black"><button onClick={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} className="glass-panel px-10 py-5 rounded-2xl text-white font-bold uppercase tracking-[0.2em] border border-blue-500/30 hover:bg-blue-600/20"><i className="fa-brands fa-google mr-3"></i> Initialize Uplink</button></div>;
            
            // Show connecting screen if stuck
            if(!connected) return <div className="h-full flex items-center justify-center bg-black text-blue-500 font-mono animate-pulse">ESTABLISHING SOCKET LINK...</div>;

            const activeSectorData = sectors.find(s => s.id === activeSectorId);

            return (
                <div className="flex h-full w-full overflow-hidden">
                    <NavRail sectors={sectors} activeId={activeSectorId} onSelect={setActiveSectorId} onCreateSector={handleCreateSector} />
                    {activeSectorId === 'dms' ? <DMDirectory user={user} dms={dms} onSelectDM={setActiveChannel} /> : <ContextSidebar activeSector={activeSectorId === 'global' ? 'global' : activeSectorData} user={user} onChannelSelect={setActiveChannel} activeChannel={activeChannel} onCreateChannel={handleCreateChannel} />}
                    {activeChannel && <MainStage channel={activeChannel} user={user} onViewProfile={setTargetProfile} />}
                    {targetProfile && <UserProfileModal targetUser={targetProfile} currentUser={user} onClose={() => setTargetProfile(null)} />}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>