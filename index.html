<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { background-color: #313338; color: #dbdee1; font-family: 'gg sans', 'Segoe UI', Tahoma, sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .message-anim { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .modal { background: rgba(0,0,0,0.85); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6uWFyvcdPSSaM_TWz_aIytDXiw4JkO68",
            authDomain: "omni-science-hub.firebaseapp.com",
            projectId: "omni-science-hub",
            storageBucket: "omni-science-hub.firebasestorage.app",
            messagingSenderId: "540333608940",
            appId: "1:540333608940:web:d42c58081d74bf7af17ac9"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); } catch (e) {}
        const auth = firebase.auth();
        const db = firebase.firestore();
        const { useState, useEffect, useRef } = React;

        const formatTime = (timestamp) => {
            if (!timestamp) return "";
            const date = timestamp.toDate();
            // Intelligent date formatting (Today/Yesterday)
            const now = new Date();
            const isToday = date.toDateString() === now.toDateString();
            const timeStr = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            if (isToday) return `Today at ${timeStr}`;
            return `${date.toLocaleDateString()} ${timeStr}`;
        };

        // --- COMPONENTS ---

        function SettingsModal({ user, onClose }) {
            const [newName, setNewName] = useState(user.displayName || "");
            const [newPhoto, setNewPhoto] = useState(user.photoURL || "");
            const [loading, setLoading] = useState(false);

            const handleSave = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await user.updateProfile({ displayName: newName, photoURL: newPhoto });
                    onClose();
                    window.location.reload(); 
                } catch (err) { alert(err.message); }
                setLoading(false);
            };

            return (
                <div className="fixed inset-0 modal flex items-center justify-center z-50 p-4">
                    <div className="bg-[#313338] p-6 rounded-lg max-w-sm w-full shadow-2xl border border-[#1e1f22]">
                        <h2 className="text-xl font-bold text-white mb-4">Edit Profile</h2>
                        <form onSubmit={handleSave} className="space-y-4">
                            <div>
                                <label className="text-xs text-gray-400 uppercase font-bold">Display Name</label>
                                <input type="text" value={newName} onChange={e => setNewName(e.target.value)}
                                    className="w-full bg-[#1e1f22] text-white p-2.5 rounded mt-1 outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div>
                                <label className="text-xs text-gray-400 uppercase font-bold">Avatar URL</label>
                                <input type="text" value={newPhoto} onChange={e => setNewPhoto(e.target.value)} placeholder="https://..."
                                    className="w-full bg-[#1e1f22] text-white p-2.5 rounded mt-1 outline-none focus:ring-2 focus:ring-indigo-500" />
                            </div>
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={onClose} className="flex-1 hover:underline text-white py-2">Cancel</button>
                                <button type="submit" className="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded font-medium transition">
                                    {loading ? "Saving..." : "Save"}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function Login() {
            const handleGoogle = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
            return (
                <div className="flex items-center justify-center min-h-screen bg-[#313338] bg-[url('https://www.transparenttextures.com/patterns/stardust.png')]">
                    <div className="text-center space-y-8 p-10">
                        <div className="flex justify-center mb-4">
                            <div className="w-20 h-20 bg-indigo-500 rounded-2xl flex items-center justify-center shadow-lg rotate-3 hover:rotate-0 transition duration-500">
                                <i className="fa-solid fa-atom text-white text-4xl"></i>
                            </div>
                        </div>
                        <h1 className="text-5xl font-black text-white tracking-tight">Omni-Media</h1>
                        <p className="text-gray-400 text-lg">Connect. Collaborate. Create.</p>
                        <button onClick={handleGoogle} className="px-8 py-3 bg-white text-gray-900 font-bold rounded-full hover:scale-105 transition shadow-xl flex items-center gap-3 mx-auto">
                            <img src="https://www.svgrepo.com/show/475656/google-color.svg" className="w-5 h-5"/>
                            Enter Hub
                        </button>
                    </div>
                </div>
            );
        }

        function ChatRoom({ user }) {
            const [messages, setMessages] = useState([]);
            const [text, setText] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const bottomRef = useRef(null);

            useEffect(() => {
                const unsub = db.collection("messages").orderBy("timestamp", "asc").limitToLast(60).onSnapshot(snap => {
                    setMessages(snap.docs.map(d => ({id: d.id, ...d.data()})));
                    setTimeout(() => bottomRef.current?.scrollIntoView({behavior: 'smooth'}), 100);
                });
                return unsub;
            }, []);

            const send = async (e) => {
                e.preventDefault();
                if (!text.trim()) return;
                try {
                    await db.collection("messages").add({
                        text, uid: user.uid, displayName: user.displayName || "Omni-User",
                        photoURL: user.photoURL || "", timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        platform: "Web"
                    });
                    setText("");
                } catch(err) { console.error(err); }
            };

            return (
                <div className="flex flex-col h-screen bg-[#313338]">
                    {showSettings && <SettingsModal user={user} onClose={() => setShowSettings(false)} />}
                    
                    <header className="bg-[#2b2d31] p-3 px-4 border-b border-[#1f2023] flex justify-between items-center shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <i className="fa-solid fa-hashtag text-gray-400 text-xl"></i>
                            <h1 className="font-bold text-white text-lg tracking-tight">general-chat</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 cursor-pointer hover:bg-[#3f4147] p-1.5 rounded transition" onClick={() => setShowSettings(true)}>
                                <span className="text-sm font-medium text-white max-w-[150px] truncate hidden sm:block">{user.displayName}</span>
                                {user.photoURL ? 
                                    <img src={user.photoURL} className="w-8 h-8 rounded-full bg-black object-cover" /> : 
                                    <div className="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-sm font-bold text-white">{user.displayName?.[0]}</div>
                                }
                            </div>
                            <button onClick={() => auth.signOut()} className="text-gray-400 hover:text-red-400" title="Logout"><i className="fa-solid fa-right-from-bracket"></i></button>
                        </div>
                    </header>

                    <div className="flex-1 overflow-y-auto p-4 space-y-1">
                        {messages.map((msg, i) => {
                            const isSequence = i > 0 && messages[i-1].uid === msg.uid && (msg.timestamp?.seconds - messages[i-1].timestamp?.seconds < 300);
                            
                            return (
                                <div key={msg.id} className={`group flex gap-4 pr-4 pl-2 py-0.5 hover:bg-[#2e3035] rounded transition ${!isSequence ? 'mt-4' : ''} message-anim`}>
                                    {/* Avatar Column */}
                                    <div className="w-10 flex-shrink-0 pt-0.5 cursor-pointer">
                                        {!isSequence && (
                                            msg.photoURL ? 
                                            <img src={msg.photoURL} className="w-10 h-10 rounded-full bg-black object-cover hover:opacity-80 transition" /> : 
                                            <div className="w-10 h-10 bg-indigo-500 rounded-full flex items-center justify-center text-lg font-bold text-white hover:opacity-80 transition">{msg.displayName?.[0]}</div>
                                        )}
                                        {isSequence && <span className="text-[10px] text-gray-500 hidden group-hover:block ml-2">{formatTime(msg.timestamp).split('at ')[1]}</span>}
                                    </div>

                                    {/* Content Column */}
                                    <div className="flex-1 min-w-0">
                                        {!isSequence && (
                                            <div className="flex items-center gap-2">
                                                <span className="font-medium text-white hover:underline cursor-pointer">{msg.displayName}</span>
                                                {msg.platform === 'Discord' && <span className="bg-[#5865F2] text-[10px] px-1 rounded text-white font-bold">BOT</span>}
                                                <span className="text-xs text-gray-400 ml-1">{formatTime(msg.timestamp)}</span>
                                            </div>
                                        )}
                                        <p className={`text-[#dcddde] text-[15px] leading-6 whitespace-pre-wrap break-words ${msg.platform === 'Discord' ? '' : ''}`}>{msg.text}</p>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={bottomRef}></div>
                    </div>

                    <div className="p-4 bg-[#313338]">
                        <form onSubmit={send} className="bg-[#383a40] rounded-lg flex items-center px-4 py-2.5">
                            <button type="button" className="text-gray-400 hover:text-gray-200 mr-4"><i className="fa-solid fa-circle-plus text-xl"></i></button>
                            <input 
                                value={text} 
                                onChange={e => setText(e.target.value)} 
                                placeholder={`Message #${"general-chat"}`}
                                className="flex-1 bg-transparent text-white placeholder-gray-500 outline-none h-full"
                            />
                            <div className="flex gap-3 text-gray-400 text-xl ml-2">
                                <button type="submit" className={`hover:text-indigo-400 transition ${text.trim() ? 'text-indigo-500' : ''}`}><i className="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            useEffect(() => auth.onAuthStateChanged(u => { setUser(u); setLoading(false); }), []);
            if (loading) return <div className="h-screen flex items-center justify-center bg-[#313338] text-indigo-500"><i className="fa-solid fa-circle-notch fa-spin text-4xl"></i></div>;
            return user ? <ChatRoom user={user} /> : <Login />;
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>