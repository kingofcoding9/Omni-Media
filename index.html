<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Omni-Media</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'omni-dark': '#050a14',
                        'omni-panel': '#0f172a',
                        'omni-blue': '#3b82f6',
                        'omni-glass': 'rgba(15, 23, 42, 0.75)',
                    },
                    fontFamily: {
                        sans: ['"Exo 2"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* Base Resets */
        html, body {
            height: 100dvh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #020408;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
        }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar {
            width: 5px;
            height: 5px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(59, 130, 246, 0.3);
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(59, 130, 246, 0.6);
        }

        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(13, 22, 40, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .anim-fade {
            animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Markdown Styles */
        .md-link { color: #60a5fa; text-decoration: none; border-bottom: 1px dotted #60a5fa; transition: all 0.2s; }
        .md-link:hover { background: rgba(96, 165, 250, 0.1); }
        .md-code { 
            background: rgba(0,0,0,0.4); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace; 
            color: #fbbf24;
            font-size: 0.9em;
            border: 1px solid rgba(255,255,255,0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6uWFyvcdPSSaM_TWz_aIytDXiw4JkO68",
            authDomain: "omni-science-hub.firebaseapp.com",
            projectId: "omni-science-hub",
            storageBucket: "omni-science-hub.firebasestorage.app",
            messagingSenderId: "540333608940",
            appId: "1:540333608940:web:d42c58081d74bf7af17ac9"
        };
        
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const { useState, useEffect, useRef, useMemo } = React;

        // --- CONNECTION CONFIG ---
        const BACKEND_URL = "https://kingofcoding9-omni-bot-backend.hf.space"; 
        const AUTH_KEY = "e359e758-78c5-44fd-a971-9057c3d2763f"; 

        const socket = io(BACKEND_URL, {
            transports: ['polling', 'websocket'],
            reconnectionAttempts: 20,
            timeout: 20000,
            auth: { serverKey: AUTH_KEY }
        });

        // --- UTILITIES ---
        const compressImage = (file, maxWidth = 600) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height = height * (maxWidth / width);
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const generateAvatar = (name) => `https://ui-avatars.com/api/?name=${encodeURIComponent(name || 'User')}&background=random&color=fff&bold=true`;

        // --- MARKDOWN COMPONENT ---
        const RichText = React.memo(({ text }) => {
            if (!text) return null;
            const parts = text.split(/(`[^`]+`)/g);
            return (
                <span className="whitespace-pre-wrap break-words leading-relaxed">
                    {parts.map((part, i) => {
                        if (part.startsWith('`') && part.endsWith('`')) {
                            return <span key={i} className="md-code">{part.slice(1, -1)}</span>;
                        }
                        const linkRegex = /\[([^\]]+)\]\(([^)]+)\)/g;
                        const subParts = [];
                        let lastIndex = 0;
                        let match;
                        while ((match = linkRegex.exec(part)) !== null) {
                            if (match.index > lastIndex) subParts.push(parseBold(part.substring(lastIndex, match.index), `${i}-${lastIndex}`));
                            subParts.push(<a key={`${i}-${match.index}`} href={match[2]} target="_blank" rel="noopener noreferrer" className="md-link">{match[1]} <i className="fa-solid fa-arrow-up-right-from-square text-[10px]"></i></a>);
                            lastIndex = linkRegex.lastIndex;
                        }
                        if (lastIndex < part.length) subParts.push(parseBold(part.substring(lastIndex), `${i}-end`));
                        return <span key={i}>{subParts}</span>;
                    })}
                </span>
            );
        });

        const parseBold = (str, keyPrefix) => {
            const boldParts = str.split(/\*\*([^*]+)\*\*/g);
            return <span key={keyPrefix}>{boldParts.map((bPart, bI) => bI % 2 === 1 ? <strong key={bI} className="text-white font-bold">{bPart}</strong> : bPart)}</span>;
        };

        // --- SUB-COMPONENTS ---

        const NavRail = ({ sectors, activeId, onSelect, onCreateSector, user, onOpenProfile }) => {
            return (
                <div className="w-[70px] h-full flex flex-col items-center py-4 gap-3 bg-black/40 border-r border-slate-800 flex-shrink-0 overflow-y-auto custom-scroll z-40">
                    <div onClick={() => onSelect('global')} className={`group relative flex-shrink-0 w-12 h-12 rounded-[20px] flex items-center justify-center cursor-pointer transition-all duration-300 hover:rounded-xl ${activeId === 'global' ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50 rounded-xl' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-700 hover:text-white'}`}>
                        <i className="fa-solid fa-earth-americas text-xl"></i>
                        {activeId === 'global' && <div className="absolute -left-1 top-1/2 -translate-y-1/2 w-1 h-8 bg-white rounded-r-lg"></div>}
                    </div>
                    <div className="w-8 h-[2px] bg-slate-800 rounded-full flex-shrink-0 my-1"></div>
                    <div className="flex-1 w-full flex flex-col items-center gap-3">
                        {sectors.map(sector => (
                            <div key={sector.id} onClick={() => onSelect(sector.id)} className="relative group w-12 h-12 flex-shrink-0">
                                {activeId === sector.id && <div className="absolute -left-[11px] top-1/2 -translate-y-1/2 w-1 h-8 bg-white rounded-r-lg z-10"></div>}
                                <div className={`w-full h-full rounded-[20px] group-hover:rounded-xl flex items-center justify-center cursor-pointer transition-all duration-300 overflow-hidden border-2 ${activeId === sector.id ? 'border-blue-500' : 'border-transparent group-hover:border-slate-600 bg-slate-800'}`}>
                                    {sector.icon ? <img src={sector.icon} className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-sm font-bold text-white bg-gradient-to-br from-slate-700 to-slate-800">{sector.name.substring(0, 2).toUpperCase()}</div>}
                                </div>
                                <div className="absolute left-16 top-1/2 -translate-y-1/2 bg-black px-3 py-1 rounded text-xs text-white opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap z-50 border border-slate-800 font-bold tracking-wider">{sector.name}</div>
                            </div>
                        ))}
                        <div onClick={onCreateSector} className="flex-shrink-0 w-12 h-12 rounded-[20px] hover:rounded-xl bg-slate-800/30 border border-dashed border-slate-600 text-slate-500 hover:text-green-400 hover:border-green-400 flex items-center justify-center cursor-pointer transition-all"><i className="fa-solid fa-plus"></i></div>
                    </div>
                    <div onClick={() => onSelect('dms')} className={`flex-shrink-0 w-12 h-12 rounded-[20px] hover:rounded-xl flex items-center justify-center cursor-pointer transition-all duration-300 mb-2 ${activeId === 'dms' ? 'bg-purple-600 text-white shadow-lg shadow-purple-900/50 rounded-xl' : 'bg-slate-800 text-slate-400 hover:text-white'}`}><i className="fa-solid fa-inbox text-lg"></i></div>
                    <div onClick={onOpenProfile} className="relative group w-12 h-12 flex-shrink-0 mb-2 cursor-pointer">
                        <img src={user.photoURL || generateAvatar(user.displayName)} className="w-full h-full rounded-[20px] group-hover:rounded-xl border-2 border-slate-700 hover:border-blue-400 object-cover transition-all" />
                        <div className="absolute bottom-0 right-0 w-3.5 h-3.5 bg-green-500 rounded-full border-2 border-[#050a14]"></div>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ activeSectorData, activeSectorId, user, dms, onChannelSelect, activeChannelId, onCreateChannel, isMobile }) => {
            const isDM = activeSectorId === 'dms';
            const [searchTerm, setSearchTerm] = useState("");
            
            // Safety check: if we are supposed to show a sector but data is missing
            if (!isDM && !activeSectorData) {
                return (
                     <div className="w-full md:w-64 h-full bg-[#0a0f16] flex flex-col border-r border-slate-800/50 flex-shrink-0 items-center justify-center text-slate-600">
                        <i className="fa-solid fa-spinner fa-spin mb-2"></i>
                        <span className="text-xs">Loading Sector...</span>
                    </div>
                );
            }

            let title = "UNKNOWN";
            let subtitle = "SECTOR";
            if (isDM) { 
                title = "DIRECT UPLINKS"; 
                subtitle = "ENCRYPTED"; 
            } else if (activeSectorData) { 
                title = activeSectorData.name; 
                subtitle = activeSectorData.id === 'global' ? "PUBLIC RELAY" : "SECURE SECTOR"; 
            }

            return (
                <div className="w-full md:w-64 h-full bg-[#0a0f16] flex flex-col border-r border-slate-800/50 flex-shrink-0">
                    <div className="h-16 px-4 flex flex-col justify-center border-b border-slate-800/60 shadow-sm bg-[#0a0f16]">
                        <h2 className="font-bold text-white truncate text-sm tracking-widest">{title.toUpperCase()}</h2>
                        <p className="text-[10px] text-blue-500 font-mono tracking-wider">{subtitle}</p>
                    </div>

                    <div className="flex-1 overflow-y-auto custom-scroll p-2 space-y-4">
                        {isDM ? (
                            <>
                                <div className="px-2"><input type="text" placeholder="Filter Uplinks..." className="w-full bg-slate-900 border border-slate-800 rounded px-3 py-1.5 text-xs text-white focus:border-blue-500 outline-none transition" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                <div className="space-y-1">
                                    {dms.filter(dm => {
                                        const otherId = dm.participants.find(p => p !== user.uid);
                                        const name = dm.names ? dm.names[otherId] : "Unknown";
                                        return name.toLowerCase().includes(searchTerm.toLowerCase());
                                    }).map(dm => {
                                        const otherId = dm.participants.find(p => p !== user.uid);
                                        const name = dm.names ? dm.names[otherId] : "Unknown Operative";
                                        return (
                                            <div key={dm.id} onClick={() => onChannelSelect({id: dm.id, name, type: 'dm'})} className={`p-2 rounded-lg flex items-center gap-3 cursor-pointer transition border border-transparent ${activeChannelId === dm.id ? 'bg-slate-800 border-slate-700' : 'hover:bg-slate-800/50'}`}>
                                                <img src={generateAvatar(name)} className="w-8 h-8 rounded-full" />
                                                <div className="overflow-hidden"><p className="font-semibold text-sm text-slate-200 truncate">{name}</p><p className="text-[10px] text-slate-500 truncate">Secure Line Ready</p></div>
                                            </div>
                                        );
                                    })}
                                    {dms.length === 0 && <div className="text-center text-xs text-slate-600 mt-4">No Active Uplinks</div>}
                                </div>
                            </>
                        ) : (
                            <>
                                {['text', 'voice', 'forum'].map(type => {
                                    // Ensure channels array exists with || []
                                    const channels = activeSectorData.channels?.filter(c => c.type === type) || [];
                                    // Only show Text channels for Global usually, but let's be flexible
                                    if (activeSectorData.id === 'global' && type !== 'text') return null;
                                    
                                    return (
                                        <div key={type} className="mb-4">
                                            <div className="flex items-center justify-between px-2 mb-1 group">
                                                <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                                                    {type === 'text' && <i className="fa-solid fa-hashtag text-[9px]"></i>}
                                                    {type === 'voice' && <i className="fa-solid fa-microphone text-[9px]"></i>}
                                                    {type.toUpperCase()} CHANNELS
                                                </span>
                                                {/* Only owner can create channels */}
                                                {activeSectorData.ownerId === user.uid && (
                                                    <button onClick={() => onCreateChannel(type)} className="text-slate-600 hover:text-white opacity-0 group-hover:opacity-100 transition"><i className="fa-solid fa-plus text-[10px]"></i></button>
                                                )}
                                            </div>
                                            <div className="space-y-[2px]">
                                                {channels.map(ch => (
                                                    <div key={ch.id} onClick={() => onChannelSelect(ch)} className={`group px-2 py-1.5 rounded mx-1 cursor-pointer flex items-center gap-2 transition-all ${activeChannelId === ch.id ? 'bg-slate-700/60 text-white shadow-sm' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`}>
                                                        <i className={`fa-solid ${type === 'voice' ? 'fa-volume-high' : 'fa-hashtag'} text-xs opacity-50 w-4 text-center`}></i>
                                                        <span className="text-sm font-medium truncate">{ch.name}</span>
                                                    </div>
                                                ))}
                                                {channels.length === 0 && <div className="px-4 text-[10px] text-slate-700 italic py-1">No channels</div>}
                                            </div>
                                        </div>
                                    );
                                })}
                            </>
                        )}
                    </div>
                    <div className="h-14 bg-[#080c11] flex items-center px-3 border-t border-slate-800/50 gap-3">
                        <img src={user.photoURL || generateAvatar(user.displayName)} className="w-8 h-8 rounded-lg object-cover" />
                        <div className="flex-1 min-w-0"><p className="text-xs font-bold text-white truncate">{user.displayName}</p><p className="text-[10px] text-slate-500 truncate">#{user.uid.slice(0,4)}</p></div>
                        <button onClick={() => auth.signOut()} className="text-slate-500 hover:text-red-400 transition"><i className="fa-solid fa-power-off"></i></button>
                    </div>
                </div>
            );
        };

        const MainStage = ({ channel, user, onViewProfile, onBack }) => {
            const [messages, setMessages] = useState([]);
            const [inputText, setInputText] = useState("");
            const bottomRef = useRef();
            const [isUploading, setIsUploading] = useState(false);
            const [isStreaming, setIsStreaming] = useState(false);
            const [isInCall, setIsInCall] = useState(false);

            useEffect(() => {
                if (!channel) return;
                setMessages([]);
                socket.emit('join_channel', channel.id);
                const handleNewMsg = (msg) => { setMessages(prev => [...prev, msg]); setTimeout(() => bottomRef.current?.scrollIntoView({behavior:'smooth'}), 100); };
                const handleHistory = (hist) => { setMessages(hist || []); setTimeout(() => bottomRef.current?.scrollIntoView({behavior:'auto'}), 50); };
                socket.on('new_message', handleNewMsg);
                socket.on('channel_history', handleHistory);
                return () => { socket.off('new_message', handleNewMsg); socket.off('channel_history', handleHistory); socket.emit('leave_channel', channel.id); };
            }, [channel]);

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!inputText.trim()) return;
                socket.emit('send_message', { channelId: channel.id, text: inputText, uid: user.uid, displayName: user.displayName, photoURL: user.photoURL });
                setInputText("");
            };

            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                setIsUploading(true);
                try {
                    const base64 = await compressImage(file);
                    socket.emit('send_message', { channelId: channel.id, text: "", imageURL: base64, uid: user.uid, displayName: user.displayName, photoURL: user.photoURL });
                } catch(err) { alert("Upload failed."); } finally { setIsUploading(false); }
            };

            if (channel.type === 'voice') {
                return (
                    <div className="flex-1 flex flex-col bg-[#050a14] h-full relative z-50">
                        <div className="h-16 border-b border-slate-800 flex items-center px-4 bg-[#0a0f16]/90 backdrop-blur-sm sticky top-0 z-10 shadow-md">
                            <button onClick={onBack} className="md:hidden mr-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800 text-slate-400 transition"><i className="fa-solid fa-arrow-left"></i></button>
                            <i className="fa-solid fa-microphone-lines text-green-500 mr-3"></i>
                            <div><h1 className="font-bold text-white text-base leading-tight">{channel.name}</h1><p className="text-[10px] text-green-500 font-mono uppercase tracking-wider">Voice Connected</p></div>
                        </div>
                        <div className="flex-1 p-6 flex flex-col items-center justify-center gap-8 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 to-black">
                            <div className="w-32 h-32 rounded-full border-4 border-green-500/30 bg-slate-800 flex items-center justify-center relative shadow-[0_0_30px_rgba(34,197,94,0.2)]">
                                <img src={user.photoURL || generateAvatar(user.displayName)} className="w-28 h-28 rounded-full object-cover" />
                                <div className="absolute bottom-2 right-2 w-6 h-6 bg-green-500 rounded-full border-4 border-slate-800"></div>
                            </div>
                            <p className="text-slate-400 text-sm font-mono animate-pulse">Waiting for operatives...</p>
                            <div className="flex gap-4 mt-8">
                                <button onClick={onBack} className="px-8 h-12 rounded-full bg-red-600 text-white hover:bg-red-500 transition font-bold uppercase tracking-widest shadow-lg shadow-red-900/40">Disconnect</button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex-1 flex flex-col bg-[#050a14] h-full relative z-50">
                    <div className="h-16 border-b border-slate-800 flex items-center px-4 bg-[#0a0f16]/95 backdrop-blur-sm sticky top-0 z-10">
                        <button onClick={onBack} className="md:hidden mr-3 w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-800 text-slate-300 transition"><i className="fa-solid fa-chevron-left"></i></button>
                        <i className="fa-solid fa-hashtag text-slate-500 mr-3 text-sm"></i>
                        <div className="flex-1 min-w-0"><h1 className="font-bold text-white text-base truncate">{channel.name}</h1></div>
                    </div>
                    <div className="flex-1 overflow-y-auto custom-scroll p-4 space-y-6">
                        <div className="mt-4 mb-8 px-4">
                            <div className="w-12 h-12 rounded-full bg-slate-800 flex items-center justify-center text-2xl text-white mb-2"><i className="fa-solid fa-hashtag"></i></div>
                            <h2 className="text-2xl font-bold text-white">Welcome to #{channel.name}</h2>
                            <p className="text-slate-400 text-sm">Start of <span className="text-blue-400">{channel.name}</span>.</p>
                        </div>
                        {messages.map((msg, idx) => {
                            const isMe = msg.uid === user.uid;
                            const showHeader = idx === 0 || messages[idx-1].uid !== msg.uid || (new Date(msg.timestamp) - new Date(messages[idx-1].timestamp) > 300000);
                            return (
                                <div key={idx} className={`group flex gap-3 anim-fade ${showHeader ? 'mt-4' : 'mt-0.5'}`}>
                                    {showHeader ? <div className="flex-shrink-0 cursor-pointer hover:opacity-80 transition" onClick={() => onViewProfile({uid: msg.uid, displayName: msg.displayName, photoURL: msg.photoURL})}><img src={msg.photoURL || generateAvatar(msg.displayName)} className="w-10 h-10 rounded-full bg-slate-800 object-cover" /></div> : <div className="w-10 flex-shrink-0"></div>}
                                    <div className="flex-1 min-w-0">
                                        {showHeader && <div className="flex items-baseline gap-2 mb-0.5"><span onClick={() => onViewProfile({uid: msg.uid, displayName: msg.displayName, photoURL: msg.photoURL})} className="text-sm font-bold text-white hover:underline cursor-pointer">{msg.displayName}</span><span className="text-[10px] text-slate-500">{new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span></div>}
                                        <div className={`text-[15px] leading-snug ${isMe ? 'text-slate-100' : 'text-slate-300'}`}><RichText text={msg.text} />{msg.imageURL && <div className="mt-2 max-w-sm rounded-lg overflow-hidden border border-slate-700/50"><img src={msg.imageURL} className="w-full h-auto" /></div>}</div>
                                    </div>
                                </div>
                            );
                        })}
                        <div ref={bottomRef} className="h-4"></div>
                    </div>
                    <div className="p-3 bg-[#0a0f16] border-t border-slate-800 flex-shrink-0">
                        <div className="bg-slate-900/50 rounded-lg p-2 flex items-end gap-2 border border-slate-800 focus-within:border-blue-500/50 transition-colors">
                            <label className="p-2 text-slate-400 hover:text-white cursor-pointer transition rounded-full hover:bg-slate-800"><i className="fa-solid fa-circle-plus text-lg"></i><input type="file" className="hidden" onChange={handleFileUpload} accept="image/*" disabled={isUploading} /></label>
                            <form className="flex-1 flex" onSubmit={sendMessage}><input value={inputText} onChange={e=>setInputText(e.target.value)} placeholder={`Message #${channel.name}`} className="w-full bg-transparent border-none outline-none text-slate-200 placeholder-slate-500 py-2 max-h-32 overflow-y-auto" autoComplete="off" /></form>
                            <button onClick={sendMessage} disabled={!inputText.trim()} className={`p-2 rounded-lg transition ${inputText.trim() ? 'text-blue-500 hover:bg-blue-500/10' : 'text-slate-600 cursor-default'}`}><i className="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            );
        };

        const UserProfileModal = ({ targetUser, currentUser, onClose }) => {
            const [isEditing, setIsEditing] = useState(false);
            const [bio, setBio] = useState(targetUser.bio || "No data.");
            const [displayName, setDisplayName] = useState(targetUser.displayName);
            const isMe = currentUser.uid === targetUser.uid;
            const handleSave = async () => { if(displayName !== currentUser.displayName) { await currentUser.updateProfile({ displayName }); } socket.emit('update_profile', { uid: currentUser.uid, bio, displayName }); setIsEditing(false); };
            const handlePhoto = async (e) => { const file = e.target.files[0]; if(file) { const b64 = await compressImage(file, 200); await currentUser.updateProfile({ photoURL: b64 }); socket.emit('update_profile', { uid: currentUser.uid, photoURL: b64 }); }};

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 anim-fade" onClick={onClose}>
                    <div className="bg-[#0f172a] border border-slate-700 w-full max-w-sm rounded-2xl overflow-hidden shadow-2xl relative" onClick={e => e.stopPropagation()}>
                        <div className="h-24 bg-gradient-to-r from-blue-600 to-purple-600"></div>
                        <div className="px-6 pb-6 relative">
                            <div className="absolute -top-12 left-6"><div className="relative group"><img src={targetUser.photoURL || generateAvatar(targetUser.displayName)} className="w-24 h-24 rounded-full border-[6px] border-[#0f172a] bg-[#0f172a] object-cover" />{isMe && <label className="absolute inset-0 flex items-center justify-center bg-black/50 rounded-full opacity-0 group-hover:opacity-100 cursor-pointer transition border-[6px] border-transparent text-white"><i className="fa-solid fa-camera"></i><input type="file" className="hidden" onChange={handlePhoto} /></label>}</div></div>
                            <div className="ml-32 pt-2 flex justify-end">{isMe && !isEditing && <button onClick={() => setIsEditing(true)} className="px-3 py-1 bg-slate-800 rounded text-xs font-bold hover:bg-slate-700 transition">Edit</button>}{isMe && isEditing && <button onClick={handleSave} className="px-3 py-1 bg-green-600 rounded text-xs font-bold hover:bg-green-500 transition">Save</button>}</div>
                            <div className="mt-4">{isEditing ? <input value={displayName} onChange={e=>setDisplayName(e.target.value)} className="bg-slate-800 text-white font-bold text-xl rounded px-2 w-full mb-1" /> : <h2 className="text-xl font-bold text-white">{targetUser.displayName}</h2>}<p className="text-xs text-blue-400 font-mono">ID: {targetUser.uid.slice(0,8)}</p></div>
                            <div className="mt-6 bg-slate-900/50 rounded-lg p-3 border border-slate-800"><h3 className="text-[10px] font-bold text-slate-500 uppercase mb-1">Bio</h3>{isEditing ? <textarea value={bio} onChange={e=>setBio(e.target.value)} className="w-full bg-slate-800 text-white text-sm rounded p-2 min-h-[80px]" /> : <p className="text-sm text-slate-300 leading-relaxed">{bio}</p>}</div>
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [user, setUser] = useState(null);
            const [sectors, setSectors] = useState([]);
            const [dms, setDms] = useState([]);
            const [activeSectorId, setActiveSectorId] = useState('global');
            const [activeChannel, setActiveChannel] = useState(null);
            const [targetProfile, setTargetProfile] = useState(null);
            const [isMobile, setIsMobile] = useState(window.innerWidth < 768);

            useEffect(() => {
                const handleResize = () => setIsMobile(window.innerWidth < 768);
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(async u => { 
                    if(u) { setUser(u); const token = await u.getIdToken(); socket.emit('authenticate', token); } else { setUser(null); }
                });
                socket.on('connect', () => socket.emit('request_sync'));
                socket.on('init_data', (data) => { 
                    setSectors(data.sectors); 
                    setDms(data.dms); 
                    if(window.innerWidth > 768 && !activeChannel) {
                        const global = data.sectors.find(s=>s.id==='global');
                        if(global && global.channels) setActiveChannel(global.channels[0]);
                    }
                });
                socket.on('update_sectors', (data) => setSectors(data));
                socket.on('update_dms', (data) => setDms(data));
                return () => unsub();
            }, []);

            const handleSelectSector = (id) => {
                setActiveSectorId(id);
                if (!isMobile) {
                    if (id === 'dms') { setActiveChannel(null); } else {
                        const sec = sectors.find(s => s.id === id);
                        if(sec && sec.channels && sec.channels.length > 0) setActiveChannel(sec.channels[0]);
                    }
                } else { setActiveChannel(null); }
            };

            const handleCreateSector = () => { const name = prompt("New Sector Name:"); if(name) socket.emit('create_sector', { name, ownerId: user.uid }); };
            const handleCreateChannel = (type) => { const name = prompt(`New ${type} Channel Name:`); if(name) socket.emit('create_channel', { sectorId: activeSectorId, name, type }); };

            if (!user) {
                return (
                    <div className="h-full w-full flex items-center justify-center relative overflow-hidden bg-black">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-blue-900/20 via-black to-black"></div>
                        <div className="relative z-10 p-8 glass-panel rounded-2xl flex flex-col items-center gap-6 border border-blue-500/30 shadow-[0_0_50px_rgba(59,130,246,0.1)]">
                            <h1 className="text-4xl font-bold text-white tracking-widest font-sans">OMNI-<span className="text-blue-500">MEDIA</span></h1>
                            <p className="text-slate-400 font-mono text-xs uppercase tracking-widest">Secure Uplink Terminus</p>
                            <button onClick={() => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())} className="group relative px-8 py-3 bg-white text-black font-bold uppercase tracking-wider rounded hover:bg-blue-400 transition overflow-hidden"><span className="relative z-10 flex items-center gap-2"><i className="fa-brands fa-google"></i> Authenticate</span></button>
                            <div className="mt-8 text-[10px] text-slate-600 font-mono tracking-widest uppercase opacity-70 border-t border-slate-800 pt-4">System architecture by <span className="text-blue-500">king_of_coding</span></div>
                        </div>
                    </div>
                );
            }

            // --- CRITICAL FIX: Safe Sector Lookup ---
            // We search for the sector object. If activeSectorId is 'global', we find the one with id 'global'.
            // If it's a custom sector, we find that specific one.
            const activeSectorData = sectors.find(s => s.id === activeSectorId);

            if (isMobile) {
                return (
                    <div className="flex h-full w-full overflow-hidden bg-[#050a14]">
                        {activeChannel ? (
                            <div className="absolute inset-0 z-50 w-full h-full bg-[#050a14]"><MainStage channel={activeChannel} user={user} onViewProfile={setTargetProfile} onBack={() => setActiveChannel(null)} /></div>
                        ) : (
                            <>
                                <NavRail sectors={sectors} activeId={activeSectorId} onSelect={handleSelectSector} onCreateSector={handleCreateSector} user={user} onOpenProfile={() => setTargetProfile(user)} />
                                <Sidebar activeSectorData={activeSectorData} activeSectorId={activeSectorId} activeChannelId={null} user={user} dms={dms} onChannelSelect={setActiveChannel} onCreateChannel={handleCreateChannel} isMobile={true} />
                            </>
                        )}
                        {targetProfile && <UserProfileModal targetUser={targetProfile} currentUser={user} onClose={() => setTargetProfile(null)} />}
                    </div>
                );
            }

            return (
                <div className="flex h-full w-full overflow-hidden bg-[#050a14]">
                    <NavRail sectors={sectors} activeId={activeSectorId} onSelect={handleSelectSector} onCreateSector={handleCreateSector} user={user} onOpenProfile={() => setTargetProfile(user)} />
                    <Sidebar activeSectorData={activeSectorData} activeSectorId={activeSectorId} activeChannelId={activeChannel?.id} user={user} dms={dms} onChannelSelect={setActiveChannel} onCreateChannel={handleCreateChannel} isMobile={false} />
                    {activeChannel ? <MainStage channel={activeChannel} user={user} onViewProfile={setTargetProfile} onBack={() => setActiveChannel(null)} /> : <div className="flex-1 flex flex-col items-center justify-center text-slate-600 select-none bg-black/20"><i className="fa-solid fa-satellite-dish text-6xl mb-4 opacity-20"></i><p className="font-mono text-sm tracking-widest">AWAITING FREQUENCY SELECTION</p></div>}
                    {targetProfile && <UserProfileModal targetUser={targetProfile} currentUser={user} onClose={() => setTargetProfile(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>